window.errors=[];const rootSelectors=[".catalog-items-list",];function getElementBySelectors(e,t,o){for(let s of e)if(el=document.querySelector(s))return el;if(t)throw Error(`Не удается найти [${o}]`);return null}function getRoot(){return getElementBySelectors(rootSelectors,!0,"root")}class Promokod{constructor(e,t,o,s){this.key=e,this.minPrice=t,this.discount=o,this.isActive=s}toString(){return`${this.key}||${this.minPrice}||${this.discount}`}equals(e){return e instanceof Promokod&&this.key==e.key&&this.minPrice==e.minPrice&&this.discount==e.discount}}class PromokodesManager{static suffix="mm-best-price-promokodes";static downloadUrl="https://raw.githubusercontent.com/kennymakkormik/mm_cashback_styles/main/promocodes";static async download(){let e=await fetch(PromokodesManager.downloadUrl);if(200===e.status){let t=await e.text();return console.log(t),window.testText=t,PromokodesManager.parsePromokodes(t)}return console.log(`чтото пошло не так. Статус - ${e.status}`),window.errors.push(`чтото пошло не так. Статус - ${e.status}`),[["НЕ",1e4,3e3,!0],["РАБОТАЕТ",2100,300,!1],]}static parsePromokodes(e){let t=[],o=e.split("\n");for(let s of o)try{let r=s.split(", ");if(4!=r.length)continue;r[1]=parseInt(r[1]),r[2]=parseInt(r[2]),r[3]="true"==r[3],t.push(r)}catch{console.log(`чтото с промокодом ${s} пропуск`),window.errors(`чтото с промокодом ${s} пропуск`)}return t}static getFromStorage(){try{return JSON.parse(localStorage.getItem(PromokodesManager.suffix))}catch{return null}}static save(e){return console.log(`promokodes for saving: ${e}`),localStorage.setItem(PromokodesManager.suffix,JSON.stringify(e)),console.log(`saved ${e.length} promokodes`),e}static async get(){document.body.style.cursor="wait";let e=PromokodesManager.getFromStorage();return e||(e=await PromokodesManager.download(),PromokodesManager.save(e)),document.body.style.cursor="auto",e}static removeAll(){localStorage.removeItem(PromokodesManager.suffix)}}class TotalPrice{static className="mm-cashback-total-price";static selector=`.${TotalPrice.className}`;constructor(e,t,o,s){if(s&&e<s.minPrice)throw Error(`Промокод ${s.key} не проходит по минимальной цене (${s.minPrice})`);this._price=e,this.oldPrice=t,this.discountPercent=t?Math.round((1-e/t)*100):0,this._bonus=o,this.bonusPercent=Math.round(o/e*100),this.promokod=s,this._totalPrice=null,this._totalBonus=null}get price(){return null===this._totalPrice&&(this.promokod?this._totalPrice=this._price-this.promokod.discount:this._totalPrice=this._price),this._totalPrice}get bonus(){return null===this._totalBonus&&(this._totalBonus=Math.round(this.price*this.bonusPercent/100)),this._totalBonus}get priceWithBonus(){return this.price-this.bonus}}class MMItem{static promokodes=null;static priceSelector=".item-money .item-price span";static oldPriceSelector='span[class*="old-price-discount"][class$="price"]';static bonusSelector=".item-money .item-bonus span.bonus-amount";static promokodesClassName="mm-best-cashback-promokodes-select";static promokodesSelector=`.${MMItem.promokodesClassName}`;static toDeleteSelectors=[".credit-method-badge","div.item-review","div.item-bonus"];constructor(e){this._item=e,this._price=null,this._oldPrice=void 0,this._bonus=null,this._discount=null,this._prices=null,this._bestPrice=null}_getIntValue(e){let t=this._item.querySelector(e);return t?parseInt(t.textContent.replace(" ","")):0}get price(){return null===this._price&&(this._price=this._getIntValue(MMItem.priceSelector)),this._price}get oldPrice(){return void 0===this._oldPrice&&(this._oldPrice=this._getIntValue(MMItem.oldPriceSelector),0==this._oldPrice&&(this._oldPrice=null)),this._oldPrice}get bonus(){return null===this._bonus&&(this._bonus=this._getIntValue(MMItem.bonusSelector)),this._bonus}getTotalPrice(e){return new TotalPrice(this.price,this.oldPrice,this.bonus,e)}get prices(){if(this._prices)return this._prices;let e=[];if(!MMItem.promokodes)throw Error("Нет промокодов!");for(let t of MMItem.promokodes)if(t.isActive)try{e.push(this.getTotalPrice(t))}catch{}return this._prices=e,e}get bestPrice(){return this._bestPrice||(MMItem.promokodes&&this.prices.length?this._bestPrice=this.prices.sort((e,t)=>e.price-t.price)[0]:this._bestPrice=this.getTotalPrice(null)),this._bestPrice}_getPromokodesSelect(e){if(!MMItem.promokodes)throw Error("Промокод нет!");let t=document.createElement("select");for(let o of(t.className=MMItem.promokodesClassName,this.prices)){let s=document.createElement("option");s.value=o.priceWithBonus;let r=o.promokod;s.textContent=`${r.key} [${r.discount} от ${r.minPrice}]`,e&&r==e&&(s.selected=!0),t.appendChild(s)}let i=document.createElement("div");i.className=`div-${MMItem.promokodesClassName}`;let a=document.createElement("label");return a.textContent="Промокод: ",i.appendChild(a),i.appendChild(t),i}static cleanItem(e){for(let t of MMItem.toDeleteSelectors)removeElementFromPage(e.querySelector(t))}static loadPromokodes(e){MMItem.promokodes=[];let t=0;for(let o of e)(o=new Promokod(...o)).isActive&&(MMItem.promokodes.push(o),t++);return t}render(e){let t=this._item.cloneNode(!0),o=t.querySelector(MMItem.priceSelector).parentNode.parentNode;e||(e=this.bestPrice);let s=`<span class="${TotalPrice.className}">${e.priceWithBonus}</span> ₽<br>КЭШБЭК ${e.bonus} (${e.bonusPercent}%)`;return e.promokod&&o.insertAdjacentElement("beforebegin",this._getPromokodesSelect(e.promokod)),o.insertAdjacentHTML("beforebegin",`<span style="color:red;font-size:13pt;font-weight:700;">${s}</span><br>`),MMItem.cleanItem(t),t}static includesPromokod(e){for(let t of MMItem.promokodes)if(t.equals(e))return!0;return!1}}function removeElementFromPage(e){e&&e.parentNode.removeChild(e)}document.addEventListener("change",function(e){let t=e.target;t.className==MMItem.promokodesClassName&&(t.parentNode.parentNode.querySelector(TotalPrice.selector).textContent=t.value)});class ItemsCollectioner{static statusTabloId="bc-id-status-tablo";static showMoreBtnSelectors=[".catalog-items-list__show-more",".cnc-catalog-listing__show-more","button.catalog-listing__show-more",];static itemsSelectors=["div.catalog-item-mobile","div.catalog-item",];static outOfStockSelectors=[".catalog-listing__out-of-stock_items",".catalog-items-list__out-of-stock-heading",];constructor(e){this.currentPage=1,e<=0&&(e=1),this.maxPage=e,this._showMoreBtn=void 0,this._isStopped=void 0,this.isActive=!1,this.items=[],getRoot().insertAdjacentHTML("beforebegin",`<div id="${ItemsCollectioner.statusTabloId}" style="font-weight: 600;font-size: 18px;"></div>`)}get showMoreBtn(){return void 0===this._showMoreBtn&&(this._showMoreBtn=getElementBySelectors(ItemsCollectioner.showMoreBtnSelectors,!1,"showMoreBtn")),this._showMoreBtn}get isStopped(){return this._isStopped||!this.isActive||(this.maxPage==this.currentPage||this.maxPage<1||getElementBySelectors(ItemsCollectioner.outOfStockSelectors,!1)||!this.showMoreBtn?(this._isStopped=!0,this.isActive=!1):this._isStopped=!1),this._isStopped}delay(e){return e||(e=3e3),new Promise(t=>setTimeout(t,e))}static removeItems(){let e=ItemsCollectioner.getItems();for(let t of e)removeElementFromPage(t)}static getItems(){let e;for(let t of ItemsCollectioner.itemsSelectors)if((e=document.querySelectorAll(t)).length)break;return e}async collectItems(){let e;for(;;){let t=(e=ItemsCollectioner.getItems()).length;if(t)return this.items=this.items.concat(Array.from(e)),ItemsCollectioner.removeItems(),console.log(`${t} collected`),t;if(this.isStopped)return 0;console.log("page loading waiting..."),await delay(1e3)}}async paginateWithCollect(){this.isActive=!0,console.log(`page - ${this.currentPage}`),await this.collectItems();let e=this.items?.length??0;return(document.getElementById(ItemsCollectioner.statusTabloId).textContent=`страница - ${this.currentPage} | товаров - ${e}`,this.isStopped)?(console.log("stopping pagination..."),console.log(`collected ${this.items.length} items...`),removeElementFromPage(this.showMoreBtn),this.items):(this.showMoreBtn.click(),this.currentPage++,await this.delay(),await this.paginateWithCollect())}}class Parser{constructor(e){if(!(e instanceof ParseParameters))throw Error("Ошибка при передаче параметров парсинга. Это не экземляр класса ParseParameters");this.parameters=e,this.pageCount=e.pageCount,this.collectioner=new ItemsCollectioner(e.pageCount),this.minPercent=e.minPercent,this.items=null,this._mmItems=null,this.location=null}get length(){return this._mmItems?this._mmItems.length:0}get mmItems(){if(this._mmItems=[],this.items)for(let e of this.items)this._mmItems.push(new MMItem(e));return this._mmItems}sortByBestPrice(e){return e.sort((e,t)=>t.bestPrice.priceWithBonus-e.bestPrice.priceWithBonus)}sortByMinPercent(e){return this.parameters.filterType==ParseParameters.filterTypeCashback?e.sort((e,t)=>e.bestPrice.bonusPercent-t.bestPrice.bonusPercent):e.sort((e,t)=>e.bestPrice.discountPercent-t.bestPrice.discountPercent)}filterByMinPercent(e){return this.parameters.filterType==ParseParameters.filterTypeCashback?e.filter(e=>e.bestPrice.bonusPercent>=this.parameters.minPercent):e.filter(e=>e.bestPrice.discountPercent>=this.parameters.minPercent)}setItems(){if(!this.items)return;ItemsCollectioner.removeItems();let e=this.mmItems;for(let t of(this.parameters.sortingType==ParseParameters.sortingTypeBestPrice?(console.log("сортировка по итоговой цене"),e=this.sortByBestPrice(e)):(console.log("сортировка по проценту"),e=this.sortByMinPercent(e)),e=this.filterByMinPercent(e)))getRoot().insertAdjacentElement("afterbegin",t.render())}async parse(){this.items||(this.items=await this.collectioner.paginateWithCollect()),this.parameters.usePromokodes?await Parser.loadPromokodes():Parser.removePromokodes(),this.setItems(),this.location=window.location.href}static async loadPromokodes(){let e=await PromokodesManager.get();return e?(MMItem.loadPromokodes(e),console.log("Промокоды загружены"),e):(console.log("Промокодов нет"),null)}static removePromokodes(){MMItem.promokodes=null}}class ParseParameters{static filterTypeDiscount="DSC";static filterTypeCashback="CSH";static sortingTypeBestPrice="BESTPRICE";static sortingTypeMinPercent="MINPERCENT";constructor(e,t,o,s,r){this.pageCount=e,this.minPercent=t,this.filterType=o,this.sortingType=s,this.usePromokodes=r}}class Modal{constructor(e,t){if(t){let o=document.createElement("div");o.id=t,this._overlay=o}let s=document.createElement("div");s.id=e,this.modal=s,this.isAdded=!1,this.isOpen=!1}add(){this._overlay&&document.body.insertAdjacentElement("beforeend",this._overlay),document.body.insertAdjacentElement("beforeend",this.modal),this.isAdded=!0}hide(){this._overlay&&(this._overlay.style.display="none"),this.modal.style.display="none",this.modal.innerHTML="",this.isOpen=!1}show(){this.isAdded||this.add(),this.modal.style.display="block",this._overlay&&(this._overlay.style.display="block",this._overlay.addEventListener("click",()=>this.hide(),{once:!0})),this.isOpen=!0}get body(){return this.modal}set body(e){"object"==typeof e?this.modal.insertAdjacentElement("beforeend",e):this.modal.insertAdjacentHTML("beforeend",e)}}class Form{static whatFindId="bc-id-w-f";static percentId="bc-id-min-per";static howSortId="bc-id-sort";static pageId="bc-id-max-page";static usePromokodesId="bc-id-use-promokodes";static submitBtnId="bc-id-smt";static itemsLengthSpanId="bc-id-items-length";static promokodesSettingsSpanId="bc-id-setting-up-promokodes";static formHtml=`<div id="div-${Form.whatFindId}">
                         <label for="${Form.whatFindId}" class="best-cashback-mm">
                           Что ищем?
                         </label>
                         <select id="${Form.whatFindId}" class="best-cashback-mm">
                           <option value="${ParseParameters.filterTypeCashback}" selected>Кэшбэк</option>
                           <option value="${ParseParameters.filterTypeDiscount}">Скидку</option>
                         </select>
                       </div>
                       <div id="div-${Form.howSortId}">
                         <label for="${Form.howSortId}" class="best-cashback-mm">Сортировка:</label>
                         <select id="${Form.howSortId}" class="best-cashback-mm">
                           <option value="${ParseParameters.sortingTypeBestPrice}" selected>По итоговой цене</option>
                           <option value="${ParseParameters.sortingTypeMinPercent}">По убыванию %</option>
                         </select>
                       </div>
                       <div id="div-${Form.percentId}">
                         <label for="${Form.percentId}" class="best-cashback-mm">
                           Минимальный %:
                         </label>
                         <input type="number" id="${Form.percentId}" class="best-cashback-mm" name="min-percent" value="0" required>
                       </div>
                       <div id="div-${Form.pageId}">
                         <label for="${Form.pageId}" class="best-cashback-mm">Страниц:</label>
                         <input type="number" id="${Form.pageId}" class="best-cashback-mm" name="max-page" value="1">
                       </div>
                       <div id="div-${Form.usePromokodesId}">
                         <input type="checkbox" id="${Form.usePromokodesId}" checked>
                         <label for="${Form.usePromokodesId}" >Учесть промокоды</label>
                         <span id="${Form.promokodesSettingsSpanId}">настроить</span>
                       </div>
                       <div>
                         <span id="${Form.itemsLengthSpanId}"><span></span> шт.</span>
                         <input id="${Form.submitBtnId}" type="submit" value="СТАРТ">
                       </div>`;static href="https://megamarket.ru";static catalogUrl="https://megamarket.ru/catalog/";static errorLinkClassName="bc-error-link";static errorHrefHtml=`<h5>Сначала откройте каталог товаров одной из категорий на <a class="${Form.errorLinkClassName}" href="${Form.catalogUrl}">МегаМаркет</a></h5>`;static errorNoItems=`<h5>Не удается найти товары. Убедитесь, что вы выбрали одну из <a class="${Form.errorLinkClassName}" href="${Form.catalogUrl}">категорий</a> и на странице выведен перечень товаров</h5>`;constructor(e){this.modal=e,this.promokodesForm=null}open(){if(window.location.href.includes(Form.href)){if(!ItemsCollectioner.getItems()?.length){this.modal.body=Form.errorNoItems,this.modal.show();return}this.modal.body=Form.formHtml,this.modal.show(),document.getElementById(Form.promokodesSettingsSpanId).addEventListener("click",e=>{this.promokodesForm||(this.promokodesForm=new PromokodesForm),this.promokodesForm.modal.isOpen||this.promokodesForm.open()});return}this.modal.body=Form.errorHrefHtml,this.modal.show()}hide(){this.modal.hide()}get formData(){let e=document.getElementById(Form.pageId).value;e=e?parseInt(e):0;let t=document.getElementById(Form.percentId).value;return t=t?parseInt(t):0,{whatFind:document.getElementById(Form.whatFindId).value,howSort:document.getElementById(Form.howSortId).value,minPercent:t,maxPage:e,usePromokodes:document.getElementById(Form.usePromokodesId).checked}}}class PromokodesForm{static modalId="bc-id-promokodes-modal";static listId="bc-id-promokodes-list";static itemClassName="bc-promokode-item";static formId="bc-id-promokodes-form";static addNewClassName="bc-add-new-promokode-input";static addNew="bc-div-id-add-new-promokode";static addNewBtnId="bc-id-add-new-promokode";static saveNewBtnId="bc-id-save-new-promokode";static deletePromokodeSpan="bc-delete-promokode";static savePromokodesBtnId="bc-id-save-promokodes";static closePromokodesBtnId="bc-id-close-promokodes";static newPromokodeName="bc-id-input-promokode-name";static newPromokodeMinPrice="bc-id-input-promokode-min-price";static newPromokodeDiscount="bc-id-new-promokode-discount";static resetPromokodesSpan="bc-id-reset-promokodes-span";static formHtml=`<div id="${PromokodesForm.formId}">
                         <div id="${PromokodesForm.listId}"></div>
                         <button type="button" id="${PromokodesForm.addNewBtnId}" class="best-cashback-mm">Добавить новый</button>
                         <div id="${PromokodesForm.addNew}" style="display: none;">
                           <input type="text" 
                                  id="${PromokodesForm.newPromokodeName}" 
                                  placeholder="Код" class="best-cashback-mm ${PromokodesForm.addNewClassName}">
                           <input type="number" 
                                  id="${PromokodesForm.newPromokodeMinPrice}" 
                                  placeholder="Мин. сумма" class="best-cashback-mm ${PromokodesForm.addNewClassName}">
                           <input type="number" 
                                  id="${PromokodesForm.newPromokodeDiscount}" 
                                  placeholder="Размер скидки" class="best-cashback-mm ${PromokodesForm.addNewClassName}">
                           <button type="button" id="${PromokodesForm.saveNewBtnId}" class="best-cashback-mm">Добавить</button>
                         </div>
                         <button type="button" id="${PromokodesForm.savePromokodesBtnId}" class="best-cashback-mm">Сохранить</button>
                         <button type="button" id="${PromokodesForm.closePromokodesBtnId}" class="best-cashback-mm">Закрыть</button>
                         <span id="${PromokodesForm.resetPromokodesSpan}">Сбросить</span>
                       </div>`;constructor(){this.modal=new Modal(PromokodesForm.modalId,"bc-id-overlay"),this.promokodes=null;let e=document.createElement("div");e.insertAdjacentHTML("beforeend",PromokodesForm.formHtml),this.body=e,document.addEventListener("click",PromokodesForm._deletePromokodeHandler)}get promokodesList(){return document.getElementById(PromokodesForm.listId)}open(){this.modal.body=this.body,this.modal.show(),this._setPromokodes(),document.getElementById(PromokodesForm.saveNewBtnId).addEventListener("click",PromokodesForm._addNewPromokode),document.getElementById(PromokodesForm.addNewBtnId).addEventListener("click",PromokodesForm._showNewPromokodeForm),document.getElementById(PromokodesForm.resetPromokodesSpan).addEventListener("click",PromokodesForm._resetPromokodesHandler.bind(this)),document.getElementById(PromokodesForm.closePromokodesBtnId).addEventListener("click",e=>this.hide()),document.getElementById(PromokodesForm.savePromokodesBtnId).addEventListener("click",e=>{e.preventDefault(),this._savePromokodes(),this.hide()},{once:!0})}hide(){this.modal.hide()}static _addPromokodeCheckbox(e){let[t,o,s,r]=e,i=document.createElement("input");i.className=PromokodesForm.itemClassName,i.type="checkbox",i.dataset.code=t,i.dataset.minPrice=o,i.dataset.discount=s,i.checked=r;let a=document.createElement("label");a.textContent=`${t} [${s}/${o}]`;let m=document.createElement("span");m.className=PromokodesForm.deletePromokodeSpan;let d=document.createElement("div");return d.className=`div-${PromokodesForm.itemClassName}`,d.appendChild(i),d.appendChild(a),d.appendChild(m),document.getElementById(PromokodesForm.listId).appendChild(d),!0}async _setPromokodes(){for(let e of(this.promokodes=await PromokodesManager.get(),this.promokodesList.innerHTML="",this.promokodes))PromokodesForm._addPromokodeCheckbox(e)}static _addNewPromokode(){let e=document.getElementById(PromokodesForm.newPromokodeName).value,t=document.getElementById(PromokodesForm.newPromokodeMinPrice).value,o=document.getElementById(PromokodesForm.newPromokodeDiscount).value;if(e&&t&&o){let s=[e,parseInt(t),parseInt(o),!0];PromokodesForm._addPromokodeCheckbox(s),PromokodesForm._clearNewPromokodeForm(),PromokodesForm._hideNewPromokodeForm()}else alert("Пожалуйста, заполните все поля")}static _clearNewPromokodeForm(){document.getElementById(PromokodesForm.newPromokodeName).value="",document.getElementById(PromokodesForm.newPromokodeMinPrice).value="",document.getElementById(PromokodesForm.newPromokodeDiscount).value=""}static _hideNewPromokodeForm(){document.getElementById(PromokodesForm.addNew).style.display="none"}static _showNewPromokodeForm(){document.getElementById(PromokodesForm.addNew).style.display="block"}static _deletePromokodeHandler(e){let t=e.target;if("SPAN"==t.tagName&&t.className==PromokodesForm.deletePromokodeSpan){let o=t.closest(`.div-${PromokodesForm.itemClassName}`);o&&removeElementFromPage(o)}}static _resetPromokodesHandler(e){PromokodesManager.removeAll(),PromokodesManager.get(),this._setPromokodes()}_savePromokodes(){PromokodesManager.save(this.formData)}get formData(){let e=[];return document.querySelectorAll(`input.${PromokodesForm.itemClassName}`).forEach(function(t){let o=t.dataset;e.push([o.code,o.minPrice,o.discount,t.checked])}),e}}class Processor{static modalId="bc-id-form";static overlayId="bc-id-overlay";static suffixPromokodes="promokodes";constructor(){this.modal=new Modal(Processor.modalId,Processor.overlayId),this.startForm=new Form(this.modal),this.parser=null}async start(){this.startForm.open(),this.parser?.location&&this.parser.location!=window.location.href&&(delete this.parser,this.parser=null),this.parser?.items?(document.getElementById(`div-${Form.pageId}`).style.display="none",document.getElementById(Form.itemsLengthSpanId).style.display="block",document.querySelector(`#${Form.itemsLengthSpanId} span`).textContent=this.parser.items.length):(document.getElementById(Form.itemsLengthSpanId).style.display="none",document.getElementById(`div-${Form.pageId}`).style.display="block"),document.getElementById(Form.submitBtnId).addEventListener("click",e=>{let t=this.startForm.formData,o=new ParseParameters(t.maxPage,t.minPercent,t.whatFind,t.howSort,t.usePromokodes);console.log(t),null===this.parser?(this.parser=new Parser(o),this.parser.parse()):(this.parser.parameters=o,this.parser.parse()),this.startForm.hide()},{once:!0})}}function getInput(){window.bestCashBack||(window.bestCashBack=new Processor),window.bestCashBack.start()}